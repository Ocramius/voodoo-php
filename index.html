<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Doctrine 2 ORM Best Practices</title>

        <meta name="description" content="Doctrine 2 ORM Best Practices">
        <meta name="author" content="Marco Pivetta">

        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

        <link rel="stylesheet" href="css/theme.css" id="theme">
        <link rel="stylesheet" href="bower_components/reveal.js/lib/css/zenburn.css">

        <!-- Printing and PDF exports -->
        <script>
            var link = document.createElement('link');
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = window.location.search.match(/print-pdf/gi) ? 'bower_components/reveal.js/css/print/pdf.css'
                : 'bower_components/reveal.js/css/print/paper.css';
            document.getElementsByTagName('head')[0].appendChild(link);
        </script>
    </head>
    <body>
        <div class="reveal">
            <div class="slides">
                
                    
                        <section><h1>Hi!</h1></section>

                    
                    
                
                    
                        <section><h1>I'm <span class="doctrine-color">Marco</span>!</h1>
</section>

                    
                    
                
                    
                        <section><h1><a href="https://twitter.com/Ocramius" target="_blank">Ocramius</a></h1>
</section>

                    
                    
                
                    
                        <section><img src="assets/img/ocramius.gif" width="40%"/></section>

                    
                    
                
                    
                        <section><img src="assets/img/roave.svg"/>
</section>

                    
                    
                
                    
                        <section><img src="assets/img/zf-logo.svg"/>
</section>

                    
                    
                
                    
                        <section><img src="assets/img/doctrine.svg"/>
</section>

                    
                    
                
                    
                        <section><h2>What is <span class="doctrine-color">Voodoo</span>?</h2>

<blockquote class="fragment">/ˈvuːduː/</blockquote>

<blockquote class="fragment">Vodou</blockquote>

<p class="fragment">
    An
    <span class="doctrine-color">African</span>
    /
    <span class="php-color">Caribbean</span>
    /
    <span class="zf-color">South US</span>
    religion
</p>
</section>

                    
                    
                
                    
                        <section><p>
    <span class="doctrine-color">Vodou</span>
    means
    <span class="php-color">Spirit</span>
    in
    <span class="zf-color">west-african</span>
</p>

<p class="fragment">
    There are different variations of
    <span class="doctrine-color">Vodou</span>
</p>

<p class="fragment">
    <span class="doctrine-color">Vodun</span>
    is a
    <span class="php-color">fatalist</span>
    creed
</p>

<p class="fragment">
    Events are pre-defined, in a chain of
    <span class="doctrine-color">cause</span>
    and
    <span class="zf-color">effect</span>
</p>

<p class="fragment">
    One must ask the <span class="php-color">lwa</span> (spirits).
</p>

<p class="fragment">
    One does not act on his or her own.
</p>
</section>

                    
                    
                
                    
                        <section><h2>
    I will skip on
    <span class="doctrine-color">Vodou</span>
    <span class="php-color">rituals</span>
</h2>

<p class="fragment">
    I just got you interested in the talk
</p>

<p class="fragment">
    I don't want to talk about a religion that <strong>I do not know</strong>
</p>
</section>

                    
                    
                
                    
                        <section><h2>What <span class="doctrine-color">Vodou</span> are we talking about?</h2>

<p class="fragment">
    <span class="php-color">PHP</span>
    <span class="zf-color">Magic</span>!
</p>

<p class="fragment">
    In <span class="php-color">Programming</span>,
    <span class="doctrine-color">Magic</span>
    is used to describe code that handles complex tasks,
    hiding that complexity to present a simple interface.
</p>

<p class="fragment" style="font-size: 30%;">
    Thanks,
    <a href="http://en.wikipedia.org/wiki/Magic_%28programming%29" target="_blank">Wikipedia!</a>
</p>
</section>

                    
                    
                
                    
                        <section><h2>Who does <span class="doctrine-color">Vodou PHP</span>?</h2>

<p class="fragment">
    Many <span class="php-color">Junior developers</span> trying to over-abstract
</p>

<p class="fragment">
    Very few <span class="zf-color">Senior developers</span>, when building compromises
</p>
</section>

                    
                    
                
                    
                        <section><h2>
    <span class="doctrine-color">Programming Magic</span>
    <br/>
    can be
    <br/>
    <span class="php-color">Very Dangerous</span>
</h2></section>

                    
                    
                
                    
                        <section><h2>
    Practice
    <br/>
    <span class="zf-color">Extreme Caution</span>
</h2></section>

                    
                    
                
                    
                        <section data-background="assets/img/warning.jpeg" ></section>

                    
                    
                
                    
                        <section><h2>
    What
    <br/>
    <span class="doctrine-color">Tools</span>
    <br/>
    do we need for
    <br/>
    <span class="php-color">Magic</span>?
</h2>

<p class="fragment">
    (just a refresh)
</p></section>

                    
                    
                
                    
                        <section><h2><span class="php-color">Magic</span> <span class="zf-color">Methods</span></h2>

<p class="fragment">
    <code>__construct</code>
    <code>__destruct</code>
    <code>__get</code>
    <code>__set</code>
    <code>__isset</code>
    <code>__unset</code>
    <code>__sleep</code>
    <code>__wakeup</code>
    <code>__clone</code>
    <code>__invoke</code>
    <code>__call</code>
    <code>__callStatic</code>
    <code>__set_state</code>
    <code>__debugInfo</code>
</p></section>

                    
                    
                
                    
                        <section><h2><span class="php-color">Reflection</span></h2>

<p class="fragment"><code>ReflectionClass</code></p>
<p class="fragment"><code>ReflectionProperty</code></p>
<p class="fragment"><code>ReflectionMethod</code></p>
<p class="fragment"><code>ReflectionFunction</code></p>
</section>

                    
                    
                
                    
                        <section><h2><span class="php-color">Closures</span>!</h2>

<p class="fragment"><code>$f = function () {};</code></p>
<p class="fragment"><code>$f = (function () {})->bindTo($that, 'Foo');</code></p>

<p class="fragment" style="font-size: 40%;">
    (No, this syntax won't work, sadly)
</p>
</section>

                    
                    
                
                    
                        <section><h2>
    Some <span class="php-color">constructs</span>
    <br/>
    and <span class="php-color">functions</span>
</h2>

<p class="fragment"><code>func_get_args()</code></p>
<p class="fragment"><code>debug_backtrace()</code></p>
<p class="fragment"><code>isset</code></p>
<p class="fragment"><code>unset</code></p>
<p class="fragment"><code>(array)</code> cast</p>
</section>

                    
                    
                
                    
                        <section><h2>Let's create a <span class="doctrine-color">puppet</span>!</h2>

<p class="fragment">Generally referred to as <span class="zf-color">friend object</span></p>
</section>

                    
                    
                
                    
                        <section><p>Our <span class="doctrine-color">puppet</span>:</p>
<pre><code data-trim>
class User
{
    private $name;
    private $surname;

    public function __construct($name, $surname)
    {
        $this->name    = $name;
        $this->surname = $surname;
    }

    public function sayHello()
    {
        return 'Hello, I\'m ' . $this->name . ' ' . $this->surname . '!' . PHP_EOL;
    }
}
</code></pre>
</section>

                    
                    
                
                    
                        <section><p>Simplistic <span class="doctrine-color">puppeteer</span>:</p>
<pre><code data-trim>
class Puppeteer
{
    public $properties = [];

    public function __construct($puppet)
    {
        foreach ((new ReflectionClass($puppet))->getProperties() as $property) {
            Closure::bind(function (& $properties) use ($property) {
                $name = $property->getName();

                $properties[$name] = & $this->$name;
            }, $puppet, $property->getDeclaringClass()->getName())
                ->__invoke($this->properties);
        }
    }
}
</code></pre>
</section>

                    
                    
                
                    
                        <section><pre><code data-trim>
$user = new User('James', 'Titcumb');

var_dump($user->sayHello());

$puppeteer = new Puppeteer($user);

$puppeteer->properties['name']    = 'A';
$puppeteer->properties['surname'] = 'Minion';

var_dump($user->sayHello());
</code></pre>
</section>

                    
                    
                
                    
                        <section><h2><span class="doctrine-color">leedavis81/altr-ego</span></h2>

<p class="fragment">A decent puppeteer example</p></section>

                    
                    
                
                    
                        <section><pre><code data-trim>
class Foo
{
    private $bar = '0';

    private saySomething($baz)
    {
        return $this->bar . $baz;
    }
}
</code></pre>

<pre class="fragment"><code data-trim>
$altrEgo = AltrEgo::create(new Foo());

$altrEgo->bar = '11';

var_dump($altrEgo->saySomething('22'));
</code></pre>
</section>

                    
                    
                
                    
                        <section><h2><span class="doctrine-color">Hiding Properties</span></h2>
</section>

                    
                    
                
                    
                        <section><pre><code data-trim>
class Thing
{
    public $something = 'foo';

    public function saySomething()
    {
        return $this->something;
    }
}
</code></pre>

<pre class="fragment"><code data-trim>
$thing = new Thing();

var_dump($thing->saySomething());

unset($thing->something);

var_dump($thing->saySomething()); // ???
</code></pre></section>

                    
                    
                
                    
                        <section><h2>What can we do with that?</h2></section>

                    
                    
                
                    
                        <section><pre><code data-trim>
class MagicThing
{
    public $something = 'foo';

    public function saySomething()
    {
        return $this->something;
    }

    public function __get($name)
    {
        throw new DomainException('Stop touching my things!');
    }
}
</code></pre>

<pre class="fragment"><code data-trim>
$thing = new Thing();

var_dump($thing->saySomething());

unset($thing->something);

var_dump($thing->saySomething()); // ???
</code></pre></section>

                    
                    
                
                    
                        <section><h1>
    <abbr title="Aspect Oriented Programming" class="doctrine-color">AOP</abbr>
</h1>

<p class="fragment">
    A
    <span class="zf-color">programming paradigm</span>
    to separate
    <span class="php-color">cross-cutting concerns</span>
</p>
</section>

                    
                    
                
                    
                        <section><p>
    Usually considered <span class="php-color">magic</span>
</p>

<p class="fragment">
    Not very different from <span class="zf-color">macros</span>
</p>

<p class="fragment">
    In <span class="php-color">PHP</span>, usually rewrites files when they are included
</p></section>

                    
                    
                
                    
                        <section><h2>lisachenko/<span class="doctrine-color">go-aop-php</span></h2>

<p class="fragment">
    <abbr title="Aspect Oriented Programming" class="doctrine-color">AOP</abbr>
    framework for PHP
</p>

<p class="fragment">
    <strong>No extensions</strong> required
</p>

</section>

                    
                    
                
                    
                        <section><pre><code data-trim>
class CatchAll implements \Go\Aop\Aspect
{
    /** @Go\Lang\Annotation\Before("execution(*->*(*))") */
    public function beforeAnything(\Go\Aop\Intercept\MethodInvocation $invocation)
    {
        var_dump($invocation->getMethod()->getName());

        return $invocation->proceed();
    }
}
</code></pre>

<pre><code data-trim>
$foo->bar();
$bar->baz();
</code></pre>
</section>

                    
                    
                
                    
                        <section><h2><span class="doctrine-color">__debugInfo</span> to make things more confusing</h2></section>

                    
                    
                
                    
                        <section><pre><code data-trim>
class Foo
{
    private $thisWillGoWrongSomewhere = 'OHAI!';

    public function __debugInfo() {
        // let me confuse you a bit
        return [];
    }
}
</code></pre>

<pre class="fragment"><code data-trim>
var_dump(new Foo());
</code></pre>
</section>

                    
                    
                
                    
                        <section data-background="assets/img/whyyy.png" ></section>

                    
                    
                
                    
                        <section data-background="assets/img/but-wait-there-s-more.jpg" ></section>

                    
                    
                
                    
                        <section><pre><code data-trim>
var_dump((object) ["\0Foo\0bar" => 'baz']);
</code></pre>
</section>

                    
                    
                
                    
                        <section><pre><code data-trim>
$foo = (object) ["\0Foo\0bar" => 'baz'];

var_dump($foo->{"\0Foo\0bar"});
</code></pre>
</section>

                    
                    
                
                    
                        <section data-background="assets/img/neutral-suspicious.png" ></section>

                    
                    
                
                    
                        <section><pre><code data-trim>
$foo = (object) ["\0Foo\0bar" => 'baz'];

var_dump($foo->bar);
</code></pre>
</section>

                    
                    
                
                    
                        <section data-background="assets/img/wtf.jpeg" ></section>

                    
                    
                
                    
                        <section><pre><code data-trim>
$foo = (object) ["\0Foo\0bar" => 'baz'];

$rp = new ReflectionProperty('stdClass', 'bar');

$rp->setAccessible(true);

var_dump($rp->getValue($foo));
</code></pre>
</section>

                    
                    
                
                    
                        <section><pre><code data-trim>
$foo = (object) ["\0Foo\0bar" => 'baz'];

var_dump(Closure::bind(function () { return $this->baz; }, $foo, 'Foo')->__invoke());
</code></pre>
</section>

                    
                    
                
                    
                        <section data-background="assets/img/trollface.jpg" ><h1><strong>
    The perfect
    <br/>
    <span class="doctrine-color">Immutable Object</span>?
</strong></h1></section>

                    
                    
                
                    
                        <section><h1><span class="doctrine-color">Voodoo</span> <span class="php-color">Libraries</span></h1></section>

                    
                    
                
                    
                        <section><h2><span class="doctrine-color">leedavis81/vent</span></h2>

<p class="fragment">Object internal initialization event system</p></section>

                    
                    
                
                    
                        <section><pre><code data-trim>
class Foo {
    use Vent\VentTrait;
    private $bar;

    public function __construct() {
        $this->registerEvent('read', 'bar', function() {
            echo 'Reading "bar"' . PHP_EOL;
        });
    }

    public function doSomething() {
        return $this->bar;
    }
}
</code></pre>

<pre class="fragment"><code data-trim>
$foo = new Foo();

$foo->doSomething();
</code></pre>
</section>

                    
                    
                
                    
                        <section><h2><span class="doctrine-color">ocramius/lazy-map</span></h2>

<p class="fragment">Super fast lazy-initialized registry</p></section>

                    
                    
                
                    
                        <section><pre><code data-trim>
$map = new \LazyMap\CallbackLazyMap(function ($name) {
    return new \ReflectionClass($name);
});
</code></pre>

<pre class="fragment"><code data-trim>
var_dump($map->ArrayObject);
var_dump($map->ArrayIterator);
</code></pre>
</section>

                    
                    
                
                    
                        <section><h2><span class="doctrine-color">TimeToogo/Pinq</span></h2>

<p class="fragment">
    Inspects
    <span class="php-color">Closures</span>
    to build custom
    <span class="zf-color">expressions</span>
    in various
    <span class="zf-color">DSLs</span>
</p>
</section>

                    
                    
                
                    
                        <section><pre><code data-trim>
$db
    ->table('customers')
    ->where(function ($row) { return $row['age'] <= 50; })
    ->orderByAscending(function ($row) { return $row['firstName']; })
    ->select(function ($row) {
        return ['fullName' => $row['firstName'] . ' ' . $row['lastName']];
    })
    ->asArray()
</code></pre>

<pre><code data-trim>
SELECT
    CONCAT(CONCAT(customers.firstName, ' '), customers.lastName) AS fullName
FROM (
    SELECT * FROM (
        SELECT * FROM (SELECT * FROM customers) AS customers
        WHERE (customers.age <= 50)
    ) AS customers
    ORDER BY customers.firstName ASC
    LIMIT 50 OFFSET 0
) AS customers
</code></pre>
</section>

                    
                    
                
                    
                        <section><h2><span class="doctrine-color">jeremeamia/super_closure</span></h2>

<p class="fragment">Save/load code</p>
<p class="fragment">Save/load your bugs! <span class="fragment">(you're welcome!)</span></p></section>

                    
                    
                
                    
                        <section><pre><code data-trim>
$serializer = new SuperClosure\Serializer();

$serialized = $serializer->serialize(function () {
    echo file_get_contents(__FILE__);
});

$serializer->unserialize($serialized)->__invoke();
</code></pre>
</section>

                    
                    
                
                    
                        <section><h2><span class="doctrine-color">ocramius/proxy-manager</span></h2>

<p class="fragment">All sorts of crazy hacks around <span class="php-color">object state</span></p>

<p class="fragment">
    <span class="doctrine-color">Lazy objects</span>,
    <span class="zf-color">AOP</span>,
    <span class="php-color">Decorators</span>
</p>
</section>

                    
                    
                
                    
                        <section><pre><code data-trim>
class Foo {
    public function __construct()
    {
        sleep(5);
    }

    public function doFoo()
    {
        echo "Foo!";
    }
}
</code></pre>

<pre class="fragment"><code data-trim>
$factory = new LazyLoadingValueHolderFactory();

$proxy = $factory->createProxy(
    'Foo',
    function (& $wrapped, $p, $m, $args, & $initializer) {
        $initializer   = null;
        $wrappedObject = new Foo();
    }
);

var_dump($proxy);
</code></pre>
</section>

                    
                    
                
                    
                        <section><pre><code data-trim>
class Foo {
    public function doFoo()
    {
        echo "Foo!";
    }
}
</code></pre>

<pre class="fragment"><code data-trim>
$factory = new AccessInterceptorScopeLocalizerFactory();

$proxy = $factory->createProxy(
    new Foo(),
    ['doFoo' => function ($proxy) { echo "pre\n"; }],
    ['doFoo' => function ($proxy) { echo "post\n"; }]
);

$proxy->doFoo();
</code></pre>
</section>

                    
                    
                
                    
                        <section><pre><code data-trim>
class Foo {
    private $bar = 'baz';

    public function sayBar()
    {
        echo $this->bar;
    }
}
</code></pre>

<pre class="fragment"><code data-trim>
$factory = new LazyLoadingGhostFactory();

$proxy = $factory->createProxy(
    'Foo',
    function ($p, $m, $args, & $initializer, array $properties) {
        $initializer              = null;
        $properties["\0Foo\0bar"] = 'HAHA!';
    }
);

$proxy->sayBar();
</code></pre>
</section>

                    
                    
                
                    
                        <section data-background="assets/img/thank-you.gif" ></section>

                    
                    
                
                    
                        <section><img src="assets/img/joind-in-14373.png" alt="rate this talk on joind.in!"/>

<h2><a href="https://joind.in/14373" target="_blank">https://joind.in/14373</a></h2>
</section>

                    
                    
                
            </div>
        </div>
        <script src="bower_components/reveal.js/lib/js/head.min.js"></script>
        <script src="bower_components/reveal.js/js/reveal.js"></script>

        <script>
            Reveal.initialize({
                controls:     true,
                progress:     true,
                history:      true,
                center:       true,
                transition:   'none',
                // Optional reveal.js plugins
                dependencies: [
                    {
                        src: 'bower_components/reveal.js/lib/js/classList.js',
                        condition: function() { return !document.body.classList; }
                    },
                    {
                        src: 'bower_components/reveal.js/plugin/markdown/marked.js',
                        condition: function() { return !!document.querySelector( '[data-markdown]' ); }
                    },
                    {
                        src: 'bower_components/reveal.js/plugin/markdown/markdown.js',
                        condition: function() { return !!document.querySelector( '[data-markdown]' ); }
                    },
                    {
                        src: 'bower_components/reveal.js/plugin/highlight/highlight.js',
                        async: true,
                        condition: function() { return !!document.querySelector( 'pre code' ); },
                        callback: function() { hljs.initHighlightingOnLoad(); }
                    },
                    {
                        src: 'bower_components/reveal.js/plugin/zoom-js/zoom.js',
                        async: true
                    },
                    {
                        src: 'bower_components/reveal.js/plugin/notes/notes.js',
                        async: true
                    }
                ]
            });
        </script>
    </body>
</html>
